@let takenExamSig = takenExam();

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/tabs/taken-exams"
        text="Back"
      ></ion-back-button>
    </ion-buttons>
    <ion-title>Exam Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Exam Details</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="ion-padding">
    <!-- Loading State -->
    @if (loading()) {
    <div
      class="ion-text-center"
      style="
        min-height: 240px;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div>
        <ion-spinner name="dots"></ion-spinner>
        <p class="ion-padding-top">Loading exam details...</p>
      </div>
    </div>
    }

    <!-- Error State -->
    @if (error()) {
    <ion-card color="danger">
      <ion-card-content>
        <ion-text color="danger">{{ error() }}</ion-text>
      </ion-card-content>
    </ion-card>
    }

    <!-- Exam Details -->
    @if (!loading() && takenExamSig) {
    <div>
      <!-- Header Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Exam Submission Details</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6" class="ion-text-center">
                <div class="ion-padding">
                  <p
                    class="ion-text-uppercase"
                    style="font-size: 0.75rem; color: var(--ion-color-medium)"
                  >
                    Score
                  </p>
                  <p style="font-size: 1.5rem; font-weight: bold">
                    {{ takenExamSig.total_points }}
                  </p>
                </div>
              </ion-col>
              <ion-col size="6" class="ion-text-center">
                <div class="ion-padding">
                  <p
                    class="ion-text-uppercase"
                    style="font-size: 0.75rem; color: var(--ion-color-medium)"
                  >
                    Percentage
                  </p>
                  <p style="font-size: 1.5rem; font-weight: bold">
                    {{ getPercentage().toFixed(1) }}%
                  </p>
                </div>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col>
                <ion-progress-bar
                  [value]="getPercentage() / 100"
                ></ion-progress-bar>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-icon
                    name="checkmark-circle-outline"
                    slot="start"
                  ></ion-icon>
                  <ion-label
                    >{{ takenExamSig.answers.length }} Answers</ion-label
                  >
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  <ion-label
                    >{{ takenExamSig.submitted_at | date: 'MMM dd, yyyy'
                    }}</ion-label
                  >
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col>
                <ion-item lines="none">
                  <ion-icon name="time-outline" slot="start"></ion-icon>
                  <ion-label>
                    <p
                      class="ion-text-uppercase"
                      style="font-size: 0.75rem; color: var(--ion-color-medium)"
                    >
                      Status
                    </p>
                    <p>{{ takenExamSig.status }}</p>
                  </ion-label>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Answers Review -->
      @if (takenExamSig.answers && takenExamSig.answers.length > 0) {
      <div class="ion-margin-top">
        <h2
          style="font-size: 1.25rem; font-weight: bold; margin: 16px 0 12px 0"
        >
          Answers Review
        </h2>
        @for (answer of takenExamSig.answers; track $index; let i = $index) {
        <!-- MCQ Item -->
        @if (answer.item.type === 'mcq') {
        <app-mcq-answer-item
          [answer]="answer"
          [index]="i"
        ></app-mcq-answer-item>
        }

        <!-- True/False Item -->
        @if (answer.item.type === 'truefalse') {
        <app-true-false-answer-item
          [answer]="answer"
          [index]="i"
        ></app-true-false-answer-item>
        }

        <!-- Short Answer Item -->
        @if (answer.item.type === 'shortanswer') {
        <app-short-answer-item
          [answer]="answer"
          [index]="i"
        ></app-short-answer-item>
        }

        <!-- Essay Item -->
        @if (answer.item.type === 'essay') {
        <!-- <app-essay-answer-item
          [answer]="answer"
          [index]="i"
          [question]="answer.item.question"
          [maxPoints]="answer.item.points"
        ></app-essay-answer-item> -->
        }

        <!-- Fill in the Blank Item -->
        @if (answer.item.type === 'fillblank') {
        <!-- <app-fill-blank-answer-item
          [answer]="answer"
          [index]="i"
          [question]="answer.item.question"
          [expectedAnswer]="answer.item.expected_answer"
          [maxPoints]="answer.item.points"
        ></app-fill-blank-answer-item> -->
        }

        <!-- Matching Item -->
        @if (answer.item.type === 'matching') {
        <!-- <app-matching-answer-item
          [answer]="answer"
          [index]="i"
          [question]="answer.item.question"
          [pairs]="answer.item.pairs"
          [maxPoints]="answer.item.points"
        ></app-matching-answer-item> -->
        }

        <!-- Fallback to generic component -->
        @if (!answer.item.type || (answer.item.type !== 'mcq' &&
        answer.item.type !== 'truefalse' && answer.item.type !== 'shortanswer'
        && answer.item.type !== 'essay' && answer.item.type !== 'fillblank' &&
        answer.item.type !== 'matching')) {
        <!-- <app-answer-item
          [answer]="answer"
          [index]="i"
          [maxPoints]="answer.item.points"
        ></app-answer-item> -->
        } }
      </div>
      }

      <!-- Action Buttons -->
      <div
        class="ion-margin-top"
        style="
          display: flex;
          gap: 8px;
          flex-direction: column;
          padding-bottom: 32px;
        "
      >
        @if (isContinueMode()) {
        <ion-button
          expand="block"
          fill="solid"
          color="primary"
          (click)="continueExam()"
        >
          <ion-icon name="play-outline" slot="start"></ion-icon>
          Continue Exam
        </ion-button>
        }
        <ion-button
          expand="block"
          fill="outline"
          color="primary"
          (click)="goBack()"
        >
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Back to List
        </ion-button>
      </div>
    </div>
    }

    <!-- Pending Grading View (Exam details not yet available) -->
    @if (!loading() && !takenExam()) {
    <div class="ion-margin-top">
      <!-- Header Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Exam Submitted Successfully!</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <div class="ion-text-center">
            <ion-icon
              name="checkmark-circle-outline"
              style="
                font-size: 64px;
                color: var(--ion-color-success);
                margin-bottom: 16px;
              "
            ></ion-icon>

            <h2
              style="font-size: 1.5rem; font-weight: bold; margin-bottom: 12px"
            >
              Pending Grading
            </h2>
            <p style="margin-bottom: 24px">
              Your exam has been successfully submitted on
              <strong
                >{{ takenExam()?.submitted_at | date: 'MMM dd, y h:mm a'
                }}</strong
              >
            </p>

            <div
              style="
                background-color: var(--ion-color-warning-tint);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 24px;
                text-align: left;
              "
            >
              <div style="display: flex; gap: 12px; align-items: flex-start">
                <ion-icon
                  name="time-outline"
                  style="
                    font-size: 28px;
                    color: var(--ion-color-warning);
                    flex-shrink: 0;
                  "
                ></ion-icon>
                <div style="flex: 1">
                  <h3
                    style="
                      font-size: 1.125rem;
                      font-weight: bold;
                      margin-bottom: 8px;
                    "
                  >
                    Results Pending Grading
                  </h3>
                  <p style="margin-bottom: 12px">
                    Your exam is currently being reviewed by your teacher.
                    Results and detailed feedback will be available once grading
                    is complete and the exam is closed.
                  </p>
                  <div
                    style="
                      background-color: var(--ion-color-warning-lighter);
                      border-radius: 6px;
                      padding: 12px;
                      margin-top: 12px;
                    "
                  >
                    <p
                      style="
                        font-weight: bold;
                        margin-bottom: 8px;
                        font-size: 0.875rem;
                      "
                    >
                      What happens next:
                    </p>
                    <ul style="list-style: none; padding: 0; margin: 0">
                      <li
                        style="
                          display: flex;
                          gap: 8px;
                          margin-bottom: 6px;
                          font-size: 0.875rem;
                        "
                      >
                        <ion-icon
                          name="arrow-forward-outline"
                          style="
                            color: var(--ion-color-warning);
                            flex-shrink: 0;
                          "
                        ></ion-icon>
                        <span>Your teacher will review your responses</span>
                      </li>
                      <li
                        style="
                          display: flex;
                          gap: 8px;
                          margin-bottom: 6px;
                          font-size: 0.875rem;
                        "
                      >
                        <ion-icon
                          name="arrow-forward-outline"
                          style="
                            color: var(--ion-color-warning);
                            flex-shrink: 0;
                          "
                        ></ion-icon>
                        <span
                          >Manual grading items will receive scores and
                          feedback</span
                        >
                      </li>
                      <li
                        style="
                          display: flex;
                          gap: 8px;
                          margin-bottom: 6px;
                          font-size: 0.875rem;
                        "
                      >
                        <ion-icon
                          name="arrow-forward-outline"
                          style="
                            color: var(--ion-color-warning);
                            flex-shrink: 0;
                          "
                        ></ion-icon>
                        <span>Once complete, teacher will close the exam</span>
                      </li>
                      <li style="display: flex; gap: 8px; font-size: 0.875rem">
                        <ion-icon
                          name="checkmark-done-outline"
                          style="
                            color: var(--ion-color-success);
                            flex-shrink: 0;
                          "
                        ></ion-icon>
                        <span
                          >You'll be able to view your results and feedback
                          after closure</span
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submission Details -->
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <ion-card>
                    <ion-card-content class="ion-padding">
                      <p
                        class="ion-text-uppercase"
                        style="
                          font-size: 0.75rem;
                          color: var(--ion-color-medium);
                          margin-bottom: 8px;
                        "
                      >
                        Submitted On
                      </p>
                      <p
                        style="
                          font-size: 1.125rem;
                          font-weight: bold;
                          margin-bottom: 4px;
                        "
                      >
                        {{ takenExam()?.submitted_at | date: 'MMM dd, y' }}
                      </p>
                      <p style="font-size: 0.875rem">
                        {{ takenExam()?.submitted_at | date: 'h:mm a' }}
                      </p>
                    </ion-card-content>
                  </ion-card>
                </ion-col>
                <ion-col size="6">
                  <ion-card color="warning">
                    <ion-card-content class="ion-padding">
                      <p
                        class="ion-text-uppercase"
                        style="font-size: 0.75rem; margin-bottom: 8px"
                      >
                        Grading Status
                      </p>
                      <p
                        style="
                          font-size: 1.125rem;
                          font-weight: bold;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 6px;
                        "
                      >
                        <ion-icon name="time-outline"></ion-icon>
                        Pending
                      </p>
                      <p style="font-size: 0.875rem; margin-top: 4px">
                        Awaiting review
                      </p>
                    </ion-card-content>
                  </ion-card>
                </ion-col>
              </ion-row>
            </ion-grid>

            <!-- Action Buttons -->
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 24px;
              "
            >
              <ion-button
                expand="block"
                fill="solid"
                color="primary"
                [routerLink]="['/tabs/exams']"
              >
                <ion-icon name="document-outline" slot="start"></ion-icon>
                Browse More Exams
              </ion-button>

              <ion-button
                expand="block"
                fill="outline"
                color="primary"
                [routerLink]="['/tabs/taken-exams']"
              >
                <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
                View Exam History
              </ion-button>
            </div>

            <!-- Help Text -->
            <div
              style="
                margin-top: 24px;
                padding-top: 24px;
                border-top: 1px solid var(--ion-color-step-200);
              "
            >
              <p
                style="
                  font-size: 0.875rem;
                  color: var(--ion-color-medium);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 6px;
                "
              >
                <ion-icon name="help-circle-outline"></ion-icon>
                Check back later to view your results
              </p>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
    }
  </div>
</ion-content>
