@let takenExamSig = takenExam();
@let loadingSig = loading();
@let errorSig = error();
@let actionSig = action();
@let isContinueModeSig = isContinueMode();

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/tabs/taken-exams"
        text="Back"
      ></ion-back-button>
    </ion-buttons>
    <ion-title>Exam Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Exam Details</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="ion-padding">
    <!-- Loading State -->
    @if (loadingSig) {
    <div
      class="ion-text-center"
      style="
        min-height: 240px;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div>
        <ion-spinner name="dots"></ion-spinner>
        <p class="ion-padding-top">Loading exam details...</p>
      </div>
    </div>
    }

    <!-- Error State -->
    @if (errorSig) {
    <ion-card color="danger">
      <ion-card-content>
        <ion-text color="danger">{{ errorSig }}</ion-text>
      </ion-card-content>
    </ion-card>
    }

    <!-- Available View (Graded) -->
    @if (!loadingSig && actionSig === 'available' && takenExamSig) {
    <div>
      <!-- Header Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Exam Submission Details</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6" class="ion-text-center">
                <div class="ion-padding">
                  <p
                    class="ion-text-uppercase"
                    style="font-size: 0.75rem; color: var(--ion-color-medium)"
                  >
                    Score
                  </p>
                  <p style="font-size: 1.5rem; font-weight: bold">
                    {{ takenExamSig.total_points }}
                  </p>
                </div>
              </ion-col>
              <ion-col size="6" class="ion-text-center">
                <div class="ion-padding">
                  <p
                    class="ion-text-uppercase"
                    style="font-size: 0.75rem; color: var(--ion-color-medium)"
                  >
                    Percentage
                  </p>
                  <p style="font-size: 1.5rem; font-weight: bold">
                    {{ getPercentage().toFixed(1) }}%
                  </p>
                </div>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col>
                <ion-progress-bar
                  [value]="getPercentage() / 100"
                ></ion-progress-bar>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-icon
                    name="checkmark-circle-outline"
                    slot="start"
                  ></ion-icon>
                  <ion-label
                    >{{ takenExamSig.answers.length }} Answers</ion-label
                  >
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  <ion-label
                    >{{ takenExamSig.submitted_at | date: 'MMM dd, yyyy'
                    }}</ion-label
                  >
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row class="ion-margin-top">
              <ion-col>
                <ion-item lines="none">
                  <ion-icon name="time-outline" slot="start"></ion-icon>
                  <ion-label>
                    <p
                      class="ion-text-uppercase"
                      style="font-size: 0.75rem; color: var(--ion-color-medium)"
                    >
                      Status
                    </p>
                    <p>{{ takenExamSig.status }}</p>
                  </ion-label>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Answers Review -->
      @if (takenExamSig.answers && takenExamSig.answers.length > 0) {
      <div class="ion-margin-top">
        <h2
          style="font-size: 1.25rem; font-weight: bold; margin: 16px 0 12px 0"
        >
          Answers Review
        </h2>
        @for (answer of takenExamSig.answers; track $index; let i = $index) {
        <!-- MCQ Item -->
        @if (answer.item.type === 'mcq') {
        <app-mcq-answer-item
          [answer]="answer"
          [index]="i"
        ></app-mcq-answer-item>
        }

        <!-- True/False Item -->
        @if (answer.item.type === 'truefalse') {
        <app-true-false-answer-item
          [answer]="answer"
          [index]="i"
        ></app-true-false-answer-item>
        }

        <!-- Short Answer Item -->
        @if (answer.item.type === 'shortanswer') {
        <app-short-answer-item
          [answer]="answer"
          [index]="i"
        ></app-short-answer-item>
        }

        <!-- Essay Item -->
        @if (answer.item.type === 'essay') {
        <app-essay-answer-item
          [answer]="answer"
          [index]="i"
        ></app-essay-answer-item>
        }

        <!-- Fill in the Blank Item -->
        @if (answer.item.type === 'fillblank') {
        <app-fill-blank-answer-item
          [answer]="answer"
          [index]="i"
        ></app-fill-blank-answer-item>
        }

        <!-- Matching Item -->
        @if (answer.item.type === 'matching') {
        <app-matching-answer-item
          [answerSig]="answer"
          [indexSig]="i"
        ></app-matching-answer-item>
        }

      }
      </div>
      }

      <!-- Action Buttons -->
      <div
        class="ion-margin-top"
        style="
          display: flex;
          gap: 8px;
          flex-direction: column;
          padding-bottom: 32px;
        "
      >
        @if (isContinueModeSig) {
        <ion-button
          expand="block"
          fill="solid"
          color="primary"
          (click)="continueExam()"
        >
          <ion-icon name="play-outline" slot="start"></ion-icon>
          Continue Exam
        </ion-button>
        }
        <ion-button
          expand="block"
          fill="outline"
          color="primary"
          (click)="goBack()"
        >
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Back to List
        </ion-button>
      </div>
    </div>
    }

    <!-- Pending Grading View (Exam details not yet available) -->
    @if (!loadingSig && (actionSig === 'pending' || actionSig === 'unavailable' || actionSig === 'unknown')) {
    <app-pending-exam
      [takenExam]="takenExamSig!"
      [action]="actionSig"
    ></app-pending-exam>
    }
  </div>
</ion-content>
