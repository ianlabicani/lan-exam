<app-exam-header [takenExam]="takenExam()">
  <app-exam-timer [remainingTime]="remainingTime()"></app-exam-timer>
</app-exam-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  <div *ngIf="loading()" style="display: flex; justify-content: center; align-items: center; height: 60vh;">
    <div style="text-align: center;">
      <ion-spinner></ion-spinner>
      <ion-text color="medium" style="display: block; margin-top: 16px;">
        <p>Loading exam...</p>
      </ion-text>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !loading()" style="padding: 24px; text-align: center;">
    <ion-text color="danger">
      <p>{{ error() }}</p>
    </ion-text>
    <ion-button (click)="goBack()" expand="block" style="margin-top: 16px;">
      Go Back
    </ion-button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading() && !error()" style="padding: 16px;">
    <!-- Empty Items State -->
    <div *ngIf="examItems().length === 0" style="text-align: center; padding: 48px 16px;">
      <ion-text color="medium">
        <p>No questions available for this exam yet.</p>
      </ion-text>
      <ion-button (click)="goBack()" expand="block" style="margin-top: 16px;">
        Go Back
      </ion-button>
    </div>

    <!-- Questions Available -->
    <div *ngIf="examItems().length > 0">
      <!-- Progress Bar -->
      <app-exam-progress
        [answered]="answeredCount()"
        [total]="examItems().length">
      </app-exam-progress>

      <!-- Current Question -->
      <div style="margin-top: 24px;">
        <app-exam-question
          [item]="currentQuestion()"
          [index]="currentQuestionIndex()"
          [currentAnswer]="currentQuestion() ? answers()[currentQuestion().id] : null"
          [isReadonly]="wasSubmitted()"
          (answerChange)="onAnswerChange($event)">
        </app-exam-question>
      </div>

      <!-- Question Navigation -->
      <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: space-between;">
        <ion-button
          fill="outline"
          [disabled]="currentQuestionIndex() === 0 || wasSubmitted()"
          (click)="goToPreviousQuestion()">
          <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
          Previous
        </ion-button>

        <!-- Quick Question Navigator -->
        <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; align-items: center;">
          <button
            *ngFor="let item of examItems(); let idx = index"
            (click)="goToQuestion(idx)"
            [style.backgroundColor]="idx === currentQuestionIndex() ? '#1f51ff' : (isAnswered(item.id) ? '#2dd36f' : '#f0f0f0')"
            [style.color]="idx === currentQuestionIndex() || isAnswered(item.id) ? 'white' : 'black'"
            [style.border]="'none'"
            [style.borderRadius]="'4px'"
            [style.padding]="'6px 8px'"
            [style.fontSize]="'12px'"
            [style.cursor]="'pointer'"
            [disabled]="wasSubmitted()">
            {{ idx + 1 }}
          </button>
        </div>

        <ion-button
          fill="outline"
          [disabled]="currentQuestionIndex() === examItems().length - 1 || wasSubmitted()"
          (click)="goToNextQuestion()">
          Next
          <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </div>

      <!-- Submit Section -->
      <div style="margin-top: 32px; padding-bottom: 32px;">
        <div *ngIf="!wasSubmitted()" style="text-align: center; padding: 16px; background-color: var(--ion-color-light); border-radius: 8px;">
          <ion-text>
            <p>You have answered <strong>{{ answeredCount() }}</strong> out of <strong>{{ examItems().length }}</strong> questions.</p>
          </ion-text>
          <ion-button
            (click)="submitExam()"
            color="success"
            expand="block"
            style="margin-top: 12px;"
            [disabled]="submitting()">
            {{ submitting() ? 'Submitting...' : 'Submit Exam' }}
          </ion-button>
        </div>

        <div *ngIf="wasSubmitted()" style="text-align: center; padding: 24px; background-color: var(--ion-color-success); border-radius: 8px; color: white;">
          <ion-text>
            <h3>âœ“ Exam Submitted Successfully!</h3>
            <p style="margin-top: 12px;">Your exam has been submitted and is now being reviewed.</p>
          </ion-text>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<!-- Submit Modal -->
<app-submit-modal
  [isOpen]="showSubmitModal()"
  [answeredCount]="answeredCount()"
  [totalQuestions]="examItems().length"
  [isSubmitting]="submitting()"
  (onClose)="closeSubmitModal()"
  (onSubmit)="performSubmit()">
</app-submit-modal>
