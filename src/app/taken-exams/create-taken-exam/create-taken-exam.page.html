<app-exam-header [takenExam]="takenExam()">
  <app-exam-timer [remainingTime]="remainingTime()"></app-exam-timer>
</app-exam-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  @if (loading()) {
    <div class="state-container">
      <div class="state-content">
        <ion-spinner></ion-spinner>
        <ion-text color="medium" class="state-text">
          <p>Loading exam...</p>
        </ion-text>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <div class="error-container">
      <ion-text color="danger">
        <p>{{ error() }}</p>
      </ion-text>
      <ion-button (click)="goBack()" expand="block" class="error-button">
        Go Back
      </ion-button>
    </div>
  }

  <!-- Main Content -->
  @if (!loading() && !error()) {
    <!-- Empty Items State -->
    @if (examItems().length === 0) {
      <div class="empty-state">
        <ion-text color="medium">
          <p>No questions available for this exam yet.</p>
        </ion-text>
        <ion-button (click)="goBack()" expand="block" class="empty-state-button">
          Go Back
        </ion-button>
      </div>
    }

    <!-- Questions Available -->
    @if (examItems().length > 0) {
      <div class="content-container">
        <!-- Progress Bar -->
        <app-exam-progress
          [answered]="answeredCount()"
          [total]="examItems().length">
        </app-exam-progress>

         <!-- Question Navigation -->
        <div class="navigation-container">
          <ion-button
            fill="outline"
            [disabled]="currentQuestionIndex() === 0 || wasSubmitted()"
            (click)="goToPreviousQuestion()">
            <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
            Previous
          </ion-button>

          <!-- Quick Question Navigator -->
          <div class="question-navigator">
            @for (item of examItems(); track item.id; let idx = $index) {
              <button
                class="question-button"
                [class.current]="idx === currentQuestionIndex()"
                [class.answered]="isAnswered(item.id)"
                (click)="goToQuestion(idx)"
                [disabled]="wasSubmitted()">
                {{ idx + 1 }}
              </button>
            }
          </div>

          <ion-button
            fill="outline"
            [disabled]="currentQuestionIndex() === examItems().length - 1 || wasSubmitted()"
            (click)="goToNextQuestion()">
            Next
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
        </div>

        <!-- Current Question -->
        <div class="question-container">
          <app-exam-question
            [item]="currentQuestion()"
            [index]="currentQuestionIndex()"
            [currentAnswer]="currentQuestion() ? answers()[currentQuestion().id] : null"
            [isReadonly]="wasSubmitted()"
            (answerChange)="onAnswerChange($event)">
          </app-exam-question>
        </div>



        <!-- Submit Section -->
        <div class="submit-section">
          @if (!wasSubmitted()) {
            <div class="submit-info-box">
              <ion-text>
                <p>You have answered <strong>{{ answeredCount() }}</strong> out of <strong>{{ examItems().length }}</strong> questions.</p>
              </ion-text>
              <ion-button
                (click)="submitExam()"
                color="success"
                expand="block"
                class="submit-button"
                [disabled]="submitting()">
                {{ submitting() ? 'Submitting...' : 'Submit Exam' }}
              </ion-button>
            </div>
          }

          @if (wasSubmitted()) {
            <div class="submit-success-box">
              <ion-text>
                <h3>âœ“ Exam Submitted Successfully!</h3>
                <p class="success-message">Your exam has been submitted and is now being reviewed.</p>
              </ion-text>
            </div>
          }
        </div>
      </div>
    }
  }
</ion-content>

<!-- Submit Modal -->
<app-submit-modal
  [isOpenSig]="showSubmitModal()"
  [answeredCountSig]="answeredCount()"
  [totalQuestionsSig]="examItems().length"
  [isSubmittingSig]="submitting()"
  (onCloseSig)="closeSubmitModal()"
  (onSubmitSig)="performSubmit()">
</app-submit-modal>
