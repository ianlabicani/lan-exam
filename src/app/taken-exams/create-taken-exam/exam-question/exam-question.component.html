@let isReadonlySig = isReadonly();
@let itemSig = item();
@let currentAnswerSig = currentAnswer();
@let indexSig = index();

<ion-card *ngIf="itemSig">
  <ion-card-header>
    <div class="question-header">
      <div class="question-meta">
        <span class="question-number">{{ indexSig + 1 }}</span>
        <span class="question-points">{{ itemSig.points }} pts</span>
        <span class="question-type">{{ itemSig.type }}</span>
      </div>
    </div>
    <ion-card-title class="question-title">{{ itemSig.question }}</ion-card-title>
  </ion-card-header>

  <ion-card-content>
    @switch (itemSig.type) {
      <!-- MCQ -->
      @case ('mcq') {
        <div class="options-container">
          @for (option of itemSig.options; let idx = $index; track idx) {
            <button
              type="button"
              class="option-button"
              [class.selected]="currentAnswerSig === idx"
              (click)="setMcq(idx)"
              [disabled]="isReadonlySig">
              <span class="option-letter">{{ letters[idx] }}</span>
              <span class="option-text">{{ option.text }}</span>
            </button>
          }
        </div>
      }

      <!-- True/False -->
      @case ('truefalse') {
        <div class="true-false-container">
          <button
            type="button"
            class="true-false-button"
            [class.selected-true]="currentAnswerSig === true"
            (click)="setTrueFalse(true)"
            [disabled]="isReadonlySig">
            True
          </button>
          <button
            type="button"
            class="true-false-button"
            [class.selected-false]="currentAnswerSig === false"
            (click)="setTrueFalse(false)"
            [disabled]="isReadonlySig">
            False
          </button>
        </div>
      }

      <!-- Fill in the Blank -->
      @case ('fillblank') {
        <ion-input
          [value]="currentAnswerSig || ''"
          (ionChange)="onText($event.detail.value || '')"
          placeholder="Enter your answer"
          [disabled]="isReadonlySig"
          clearInput
          class="answer-input">
        </ion-input>
      }

      <!-- Short Answer -->
      @case ('shortanswer') {
        <ion-textarea
          [value]="currentAnswerSig || ''"
          (ionChange)="onText($event.detail.value || '')"
          placeholder="Type your answer here..."
          rows="3"
          [disabled]="isReadonlySig"
          class="answer-textarea">
        </ion-textarea>
      }

      <!-- Essay -->
      @case ('essay') {
        <div>
          <ion-textarea
            [value]="currentAnswerSig || ''"
            (ionChange)="onEssay($event.detail.value || '')"
            placeholder="Type your answer here..."
            rows="5"
            [disabled]="isReadonlySig"
            class="answer-textarea">
          </ion-textarea>
          @if (currentAnswerSig) {
            <ion-text color="medium" class="word-count">
              <p>Words: {{ countWords(currentAnswerSig) }}</p>
            </ion-text>
          }
        </div>
      }

      <!-- Matching -->
      @case ('matching') {
        @if (itemSig.pairs?.length) {
          <div class="matching-container">
            <!-- Left Column -->
            <div class="matching-column">
              <p class="column-label">Left</p>
              <ul class="matching-list">
                @for (pair of itemSig.pairs; track $index) {
                  <li class="matching-item">{{ pair.left }}</li>
                }
              </ul>
            </div>

            <!-- Middle Column - Current Answer -->
            <div class="matching-column">
              <p class="column-label">Your Answer</p>
              <ul class="matching-list">
                @for (pair of itemSig.pairs; track $index; let i = $index) {
                  <li class="matching-answer" [class.answered]="getCurrentAnswer(i)">
                    {{ getCurrentAnswer(i) || '—' }}
                  </li>
                }
              </ul>
            </div>

            <!-- Right Column - Options -->
            <div class="matching-column">
              <p class="column-label">Select Option</p>
              <ul class="matching-list">
                @for (pair of itemSig.pairs; track $index; let i = $index) {
                  <li>
                    <select
                      class="matching-select"
                      (change)="setMatching(i, $any($event.target).value)"
                      [disabled]="isReadonlySig">
                      <option value="">Select…</option>
                      @for (right of itemSig.pairs; track $index; let j = $index) {
                        <option [value]="'' + j">{{ right.right }}</option>
                      }
                    </select>
                  </li>
                }
              </ul>
            </div>
          </div>
        } @else {
          <ion-text color="medium">
            <p>No pairs provided.</p>
          </ion-text>
        }
      }

      @default {
        <ion-text color="danger">
          <p>Unknown question type: {{ itemSig.type }}</p>
        </ion-text>
      }
    }
  </ion-card-content>
</ion-card>
